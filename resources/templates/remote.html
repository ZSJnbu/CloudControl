<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>CloudControl - 远程控制</title>
  <link rel="stylesheet" href="/static/css/terminal-theme.css">
  <link rel="stylesheet" href="/static/dropzone/dropzone.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@2.9.2/dist/xterm.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/themes/default/style.min.css">
  <style>
    .term-remote-layout {
      display: flex;
      height: calc(100vh - 50px);
      overflow: hidden;
      margin-top: 50px;
    }

    /* Left Panel - Device Screen */
    .term-screen-panel {
      width: 45vw;
      min-width: 400px;
      max-width: 700px;
      display: flex;
      flex-direction: column;
      background: var(--term-bg);
      border-right: 1px solid var(--term-border);
    }

    .term-screen-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--term-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--term-bg-dark);
    }

    .term-screen-title {
      font-family: var(--term-font);
      font-size: 0.85rem;
      color: var(--term-green);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .term-screen-title .live-badge {
      background: var(--term-green);
      color: var(--term-black);
      padding: 2px 6px;
      font-size: 0.7rem;
      font-weight: bold;
      animation: pulse-glow 2s infinite;
    }

    .term-screen-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      padding: 12px;
      position: relative;
      overflow: hidden;
    }

    .term-screen-canvas {
      max-width: 100%;
      max-height: 100%;
      border: 1px solid var(--term-border);
      box-shadow: 0 0 30px rgba(0, 255, 65, 0.1);
    }

    /* 确保 fgCanvas 正确覆盖 bgCanvas */
    #fgCanvas {
      position: absolute !important;
      z-index: 10 !important;
      background: transparent !important;
    }

    /* CRT Scanline overlay for device screen */
    .term-screen-container::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent 0px,
        transparent 1px,
        rgba(0, 0, 0, 0.1) 1px,
        rgba(0, 0, 0, 0.1) 2px
      );
      pointer-events: none;
      opacity: 0.3;
    }

    .term-finger {
      position: absolute;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: radial-gradient(circle, var(--term-green) 0%, transparent 70%);
      border: 2px solid rgba(0, 255, 65, 0.6);
      pointer-events: none;
      opacity: 0;
      transform: translate(-50%, -50%);
      transition: opacity 0.1s;
      z-index: 100;
      box-shadow: 0 0 20px var(--term-green);
    }

    .term-finger.active {
      opacity: 1;
    }

    .term-loading-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 50;
      color: var(--term-green);
      font-family: var(--term-font);
    }

    /* Control Bar */
    .term-control-bar {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: var(--term-bg-dark);
      border-top: 1px solid var(--term-border);
      justify-content: center;
    }

    .term-control-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--term-border);
      color: var(--term-text);
      font-family: var(--term-font);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .term-control-btn svg {
      width: 18px;
      height: 18px;
    }

    .term-control-btn:hover {
      border-color: var(--term-green);
      color: var(--term-green);
      box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
    }

    .term-control-btn.danger:hover {
      border-color: var(--term-red);
      color: var(--term-red);
      box-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
    }

    /* Input Section */
    .term-input-section {
      padding: 12px;
      background: var(--term-bg-dark);
      border-top: 1px solid var(--term-border);
    }

    .term-input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .term-input-row:last-child {
      margin-bottom: 0;
    }

    .term-text-input {
      flex: 1;
      background: var(--term-bg);
      border: 1px solid var(--term-border);
      color: var(--term-green);
      padding: 8px 12px;
      font-family: var(--term-font);
      font-size: 0.9rem;
    }

    .term-text-input:focus {
      outline: none;
      border-color: var(--term-green);
      box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
    }

    .term-text-input::placeholder {
      color: var(--term-text-dim);
    }

    /* Right Panel - Info & Tools */
    .term-info-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--term-bg);
    }

    /* Tabs */
    .term-tabs {
      display: flex;
      background: var(--term-bg-dark);
      border-bottom: 1px solid var(--term-border);
      overflow-x: auto;
    }

    .term-tab {
      padding: 12px 20px;
      font-family: var(--term-font);
      font-size: 0.85rem;
      color: var(--term-text-dim);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
      position: relative;
    }

    .term-tab:hover {
      color: var(--term-text);
      background: rgba(0, 255, 65, 0.05);
    }

    .term-tab.active {
      color: var(--term-green);
      background: rgba(0, 255, 65, 0.1);
    }

    .term-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--term-green);
      box-shadow: 0 0 10px var(--term-green);
    }

    .term-tab svg {
      width: 14px;
      height: 14px;
      margin-right: 6px;
      vertical-align: middle;
    }

    .term-tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .term-tab-pane {
      display: none;
    }

    .term-tab-pane.active {
      display: block;
    }

    /* Device Info Grid */
    .term-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .term-info-item {
      background: var(--term-bg-dark);
      border: 1px solid var(--term-border);
      padding: 12px;
    }

    .term-info-label {
      font-family: var(--term-font);
      font-size: 0.7rem;
      color: var(--term-text-dim);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 4px;
    }

    .term-info-value {
      font-family: var(--term-font);
      font-size: 0.95rem;
      color: var(--term-green);
    }

    /* Quick Actions */
    .term-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
    }

    /* Terminal */
    #xterm {
      height: 100%;
      min-height: 400px;
      background: #000;
      overflow: hidden;
    }

    /* Dropzone */
    .term-dropzone {
      border: 2px dashed var(--term-border);
      padding: 40px;
      text-align: center;
      background: var(--term-bg-dark);
      transition: all 0.2s;
      cursor: pointer;
    }

    .term-dropzone:hover {
      border-color: var(--term-green);
      background: rgba(0, 255, 65, 0.05);
    }

    .term-dropzone.dz-drag-hover {
      border-color: var(--term-green);
      background: rgba(0, 255, 65, 0.1);
    }

    .term-dropzone-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      color: var(--term-text-dim);
    }

    .term-dropzone-text {
      font-family: var(--term-font);
      font-size: 0.9rem;
      color: var(--term-text);
    }

    /* Inspector */
    .term-inspector-layout {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      height: 100%;
    }

    .term-inspector-screen {
      position: relative;
      background: #000;
      border: 1px solid var(--term-border);
      overflow: hidden;
    }

    .term-inspector-tree {
      background: var(--term-bg-dark);
      border: 1px solid var(--term-border);
      overflow: auto;
      max-height: 600px;
    }

    .term-inspector-props {
      background: var(--term-bg-dark);
      border: 1px solid var(--term-border);
      overflow: auto;
    }

    .term-props-table {
      width: 100%;
    }

    .term-props-table th,
    .term-props-table td {
      padding: 8px;
      border-bottom: 1px solid var(--term-border);
      font-size: 0.8rem;
      font-family: var(--term-font);
    }

    .term-props-table th {
      background: var(--term-bg);
      color: var(--term-green);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      width: 100px;
      text-align: left;
    }

    .term-props-table td {
      color: var(--term-text);
      word-break: break-all;
    }

    /* Navbar */
    .term-navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: var(--term-bg-dark);
      border-bottom: 1px solid var(--term-border);
      display: flex;
      align-items: center;
      padding: 0 16px;
      z-index: 1000;
      justify-content: space-between;
    }

    .term-navbar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .term-navbar-logo {
      color: var(--term-green);
      font-family: var(--term-font);
      font-size: 1.1rem;
      font-weight: bold;
    }

    .term-navbar-device {
      font-family: var(--term-font);
      font-size: 0.85rem;
      color: var(--term-cyan);
    }

    .term-navbar-nav {
      display: flex;
      gap: 16px;
    }

    .term-navbar-link {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--term-text);
      text-decoration: none;
      font-family: var(--term-font);
      font-size: 0.85rem;
      padding: 6px 12px;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .term-navbar-link:hover {
      color: var(--term-green);
      border-color: var(--term-border);
    }

    .term-navbar-link svg {
      width: 14px;
      height: 14px;
    }

    .term-navbar-ip {
      font-family: var(--term-font);
      font-size: 0.8rem;
      color: var(--term-green);
      background: var(--term-bg);
      padding: 4px 10px;
      border: 1px solid var(--term-border);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .term-inspector-layout {
        grid-template-columns: 1fr 1fr;
     }
    }

    @media (max-width: 992px) {
      .term-remote-layout {
        flex-direction: column;
     }

      .term-screen-panel {
        width: 100%;
        max-width: 100%;
        height: 50%;
        border-right: none;
        border-bottom: 1px solid var(--term-border);
     }

      .term-info-panel {
        height: 50%;
     }

      .term-inspector-layout {
        grid-template-columns: 1fr;
     }
    }

    /* ===== 性能监控面板 ===== */
    .term-perf-panel {
      padding: 8px 12px;
      background: var(--term-bg-dark);
      border-bottom: 1px solid var(--term-border);
      display: flex;
      gap: 16px;
      align-items: center;
      font-family: var(--term-font);
      font-size: 0.75rem;
    }

    .term-perf-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .term-perf-label {
      color: var(--term-text-dim);
    }

    .term-perf-value {
      color: var(--term-cyan);
      font-weight: bold;
    }

    .term-perf-value.warning {
      color: var(--term-yellow);
    }

    .term-perf-value.error {
      color: var(--term-red);
    }

    /* ===== 快捷短语面板 ===== */
    .term-phrases-panel {
      background: var(--term-bg-dark);
      border-top: 1px solid var(--term-border);
      max-height: 200px;
      overflow: hidden;
      transition: max-height 0.3s;
    }

    .term-phrases-panel.collapsed {
      max-height: 36px;
    }

    .term-phrases-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      cursor: pointer;
    }

    .term-phrases-title {
      font-family: var(--term-font);
      font-size: 0.75rem;
      color: var(--term-green);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .term-phrases-toggle {
      background: none;
      border: none;
      color: var(--term-text-dim);
      cursor: pointer;
      padding: 2px;
    }

    .term-phrases-toggle:hover {
      color: var(--term-green);
    }

    .term-phrases-content {
      padding: 0 12px 8px;
      max-height: 120px;
      overflow-y: auto;
    }

    .term-phrases-panel.collapsed .term-phrases-content {
      display: none;
    }

    .term-phrases-input {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }

    .term-phrases-input input {
      flex: 1;
      background: var(--term-bg);
      border: 1px solid var(--term-border);
      color: var(--term-green);
      padding: 6px 10px;
      font-family: var(--term-font);
      font-size: 0.8rem;
    }

    .term-phrases-input input:focus {
      outline: none;
      border-color: var(--term-green);
    }

    .term-phrases-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .term-phrase-item {
      display: flex;
      align-items: center;
      background: var(--term-bg);
      border: 1px solid var(--term-border);
      padding: 4px 8px;
      font-family: var(--term-font);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .term-phrase-item:hover {
      border-color: var(--term-green);
      color: var(--term-green);
      box-shadow: 0 0 8px rgba(0, 255, 65, 0.3);
    }

    .term-phrase-item:active {
      background: var(--term-green);
      color: var(--term-black);
      transform: scale(0.95);
    }

    .term-phrase-item:active .term-phrase-text {
      color: var(--term-black);
    }

    .term-phrase-send {
      margin-right: 6px;
      color: var(--term-text-dim);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .term-phrase-item:hover .term-phrase-send {
      opacity: 1;
      color: var(--term-green);
    }

    .term-phrase-text {
      color: var(--term-text);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }

    .term-phrase-item:hover .term-phrase-text {
      color: var(--term-green);
    }

    .term-phrase-delete {
      margin-left: 6px;
      color: var(--term-text-dim);
      cursor: pointer;
      padding: 0 2px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .term-phrase-item:hover .term-phrase-delete {
      opacity: 1;
    }

    .term-phrase-delete:hover {
      color: var(--term-red);
    }

    .term-phrases-empty {
      color: var(--term-text-dim);
      font-size: 0.75rem;
      text-align: center;
      padding: 8px 0;
    }

    .term-phrases-footer {
      display: flex;
      justify-content: space-between;
      padding: 6px 12px;
      border-top: 1px solid var(--term-border);
      font-size: 0.7rem;
    }

    .term-phrases-panel.collapsed .term-phrases-footer {
      display: none;
    }

    .term-phrases-count {
      color: var(--term-text-dim);
    }

    .term-phrases-clear {
      background: none;
      border: none;
      color: var(--term-text-dim);
      cursor: pointer;
      font-size: 0.7rem;
      font-family: var(--term-font);
    }

    .term-phrases-clear:hover {
      color: var(--term-red);
    }

    /* JSTree Terminal Theme */
    .jstree-default .jstree-node,
    .jstree-default .jstree-icon {
      background-image: none !important;
    }

    .jstree-default .jstree-anchor {
      color: var(--term-text) !important;
      font-family: var(--term-font) !important;
      font-size: 0.8rem !important;
    }

    .jstree-default .jstree-clicked {
      background: rgba(0, 255, 65, 0.2) !important;
      color: var(--term-green) !important;
    }

    .jstree-default .jstree-hovered {
      background: rgba(0, 255, 65, 0.1) !important;
    }
  </style>
</head>
<body class="term-body">
<div id="app">
  <!-- Navbar -->
  <nav class="term-navbar">
    <div class="term-navbar-brand">
      <span class="term-navbar-logo">[CLOUDCONTROL]</span>
      <span class="term-navbar-device">// REMOTE_CONTROL</span>
    </div>

    
    <div class="term-navbar-nav">
      <span class="term-navbar-ip">[[device.ip]]:[[device.port]]</span>
      <a :href="'http://' + device.ip + ':' + device.port + '/term'" target="_blank" class="term-navbar-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="4 17 10 11 4 5"/>
          <line x1="12" y1="19" x2="20" y2="19"/>
        </svg>
        TERM
      </a>
      <a href="/" class="term-navbar-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
        </svg>
        HOME
      </a>
    </div>
  </nav>

    <!-- Main Layout -->
    <div class="term-remote-layout">
      <!-- Left: Device Screen -->
      <div class="term-screen-panel">
        <div class="term-screen-header">
          <div class="term-screen-title">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v6m0 6v10M1 12h6m6 0h10"/>
            </svg>
            STREAM://[[deviceInfo.brand]]_[[deviceInfo.model]]
            <span class="live-badge">LIVE</span>
          </div>
          <button class="term-btn term-btn-ghost" @click="toggleScreen">
            <svg v-if="screenWS" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <svg v-else width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/>
              <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
          </button>
        </div>

        <!-- 性能监控面板 -->
        <div class="term-perf-panel">
          <div class="term-perf-item">
            <span class="term-perf-label">FPS:</span>
            <span class="term-perf-value">[[perfStats.fps]]</span>
          </div>
          <div class="term-perf-item">
            <span class="term-perf-label">截图:</span>
            <span class="term-perf-value" :class="{'warning': perfStats.screenshot > 200, 'error': perfStats.screenshot > 500}">[[perfStats.screenshot]]ms</span>
          </div>
          <div class="term-perf-item">
            <span class="term-perf-label">命令:</span>
            <span class="term-perf-value" :class="{'warning': perfStats.command > 50, 'error': perfStats.command > 100}">[[perfStats.command]]ms</span>
          </div>
        </div>

        <section class="term-screen-container" id="screen">
          <div style="position: relative; display: inline-block;">
            <canvas id="bgCanvas" class="term-screen-canvas" :style="canvasStyle"></canvas>
            <canvas id="fgCanvas" class="term-screen-canvas" :style="canvasStyle" style="position: absolute; left: 0; top: 0; z-index: 10;"></canvas>
          </div>
          <span class="term-finger finger-0"></span>
          <span class="term-finger finger-1"></span>
          <div v-if="loading" class="term-loading-overlay">
            <span class="term-cursor-blink">LOADING_</span>
          </div>
        </section>

        <!-- Control Buttons -->
        <div class="term-control-bar">
          <button class="term-control-btn danger" @click="keyevent('power')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18.36 6.64a9 9 0 1 1-12.73 0"/>
              <line x1="12" y1="2" x2="12" y2="12"/>
            </svg>
            PWR
          </button>
          <button class="term-control-btn" @click="keyevent('menu')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="12" x2="21" y2="12"/>
              <line x1="3" y1="6" x2="21" y2="6"/>
              <line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
            MENU
          </button>
          <button class="term-control-btn" @click="keyevent('home')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            </svg>
            HOME
          </button>
          <button class="term-control-btn" @click="keyevent('back')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"/>
              <polyline points="12 19 5 12 12 5"/>
            </svg>
            BACK
          </button>
        </div>

        <!-- Text Input -->
        <div class="term-input-section">
          <div class="term-input-row">
            <input type="text" class="term-text-input" placeholder="> input_text --send"
                   v-model="inputText" @keydown.enter="sendTextToPhone">
            <button class="term-btn term-btn-primary" @click="sendTextToPhone">SEND</button>
            <button class="term-btn term-btn-ghost" @click="sendBackspace" title="删除">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/>
                <line x1="18" y1="9" x2="12" y2="15"/>
                <line x1="12" y1="9" x2="18" y2="15"/>
              </svg>
            </button>
          </div>
          <div class="term-input-row">
            <input type="file" id="fileInput" ref="fileInput" style="display:none" @change="uploadFile">
            <button class="term-btn term-btn-success" @click="$refs.fileInput.click()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              UPLOAD
            </button>
            <span v-if="uploadStatus" style="font-size: 0.8rem; color: var(--term-text-dim);">[[uploadStatus]]</span>
          </div>
        </div>

        <!-- 快捷短语面板 -->
        <div class="term-phrases-panel" :class="{collapsed: phrasesCollapsed}">
          <div class="term-phrases-header" @click="phrasesCollapsed = !phrasesCollapsed">
            <div class="term-phrases-title">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              <span>快捷短语</span>
            </div>
            <button class="term-phrases-toggle" @click.stop="phrasesCollapsed = !phrasesCollapsed">
              <svg v-if="phrasesCollapsed" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
              <svg v-else width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="18 15 12 9 6 15"/>
              </svg>
            </button>
          </div>
          <div class="term-phrases-content">
            <div class="term-phrases-input">
              <input type="text" v-model="newPhrase" @keydown.enter="addPhrase" placeholder="输入短语后回车添加...">
              <button class="term-btn term-btn-ghost" @click="addPhrase" style="padding: 4px 8px;">+</button>
            </div>
            <div class="term-phrases-list" v-if="phrases.length > 0">
              <div v-for="(phrase, index) in phrases" :key="index" class="term-phrase-item" @click="sendPhrase(phrase)" title="点击发送">
                <svg class="term-phrase-send" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
                <span class="term-phrase-text">[[phrase]]</span>
                <span class="term-phrase-delete" @click.stop="deletePhrase(index)" title="删除">×</span>
              </div>
            </div>
            <div v-else class="term-phrases-empty">
              暂无快捷短语，输入后回车添加
            </div>
          </div>
          <div class="term-phrases-footer">
            <span class="term-phrases-count">[[ phrases.length ]] 条短语</span>
            <button class="term-phrases-clear" @click="clearAllPhrases" v-if="phrases.length > 0">清空全部</button>
          </div>
        </div>
      </div>

      <!-- Right: Info Panel -->
      <div class="term-info-panel">
        <!-- Tabs -->
        <div class="term-tabs">
          <button class="term-tab" :class="{active: activeTab === 'home'}" @click="activeTab = 'home'">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            </svg>
            INFO
          </button>
          <button class="term-tab" :class="{active: activeTab === 'terminal'}" @click="activeTab = 'terminal'">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="4 17 10 11 4 5"/>
              <line x1="12" y1="19" x2="20" y2="19"/>
            </svg>
            SHELL
          </button>
          <button class="term-tab" :class="{active: activeTab === 'explorer'}" @click="activeTab = 'explorer'">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            FILES
          </button>
          <button class="term-tab" :class="{active: activeTab === 'inspector'}" @click="activeTab = 'inspector'">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            INSPECT
          </button>
        </div>

        <!-- Tab Content -->
        <div class="term-tab-content">
          <!-- Home Tab -->
          <div class="term-tab-pane" :class="{active: activeTab === 'home'}">
            <div class="term-section-header">
              <span class="term-prompt">root@device</span>:<span class="term-path">~</span>$ cat /proc/device_info
            </div>

            <div class="term-info-grid" style="margin-top: 12px;">
              <div class="term-info-item">
                <div class="term-info-label">BRAND</div>
                <div class="term-info-value">[[deviceInfo.brand || '--']]</div>
              </div>
              <div class="term-info-item">
                <div class="term-info-label">MODEL</div>
                <div class="term-info-value">[[deviceInfo.model || '--']]</div>
              </div>
              <div class="term-info-item">
                <div class="term-info-label">ANDROID</div>
                <div class="term-info-value">[[deviceInfo.version || '--']]</div>
              </div>
              <div class="term-info-item">
                <div class="term-info-label">SDK</div>
                <div class="term-info-value">[[deviceInfo.sdk || '--']]</div>
              </div>
              <div class="term-info-item">
                <div class="term-info-label">DISPLAY</div>
                <div class="term-info-value">[[deviceInfo.display ? deviceInfo.display.width + 'x' + deviceInfo.display.height : '--']]</div>
              </div>
              <div class="term-info-item">
                <div class="term-info-label">MEMORY</div>
                <div class="term-info-value">[[deviceInfo.memory ? deviceInfo.memory.around : '--']]</div>
              </div>
              <div class="term-info-item">
                <div class="term-info-label">CPU</div>
                <div class="term-info-value">[[deviceInfo.cpu ? deviceInfo.cpu.cores + ' cores' : '--']]</div>
              </div>
              <div class="term-info-item">
                <div class="term-info-label">IP_ADDR</div>
                <div class="term-info-value">[[deviceInfo.ip || device.ip]]</div>
              </div>
            </div>

            <div class="term-section-header" style="margin-top: 24px;">
              <span class="term-prompt">root@device</span>:<span class="term-path">~</span>$ ./quick_actions.sh
            </div>

            <div class="term-quick-actions">
              <button class="term-btn term-btn-secondary" @click="runShell('am start -a android.settings.SETTINGS')">
                [SETTINGS]
              </button>
              <button class="term-btn term-btn-secondary" @click="runShell('am start -a com.android.settings.APPLICATION_DEVELOPMENT_SETTINGS')">
                [DEV_OPTIONS]
              </button>
              <button class="term-btn term-btn-secondary" @click="runShell('am start -a android.settings.WIFI_SETTINGS')">
                [WIFI]
              </button>
              <button class="term-btn term-btn-secondary" @click="runShell('monkey -p com.tencent.mm -c android.intent.category.LAUNCHER 1')">
                [WECHAT]
              </button>
            </div>

            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px dashed var(--term-border);">
              <div class="term-section-header">
                <span class="term-prompt">root@device</span>:<span class="term-path">~</span>$ atx-agent --manage
              </div>
              <div class="term-quick-actions" style="margin-top: 8px;">
                <button class="term-btn term-btn-success" @click="atxAgentManager('start')">[START]</button>
                <button class="term-btn term-btn-danger" @click="atxAgentManager('stop')">[STOP]</button>
                <button class="term-btn term-btn-secondary" @click="atxAgentManager('restart')">[RESTART]</button>
              </div>
            </div>
          </div>

          <!-- Terminal Tab -->
          <div class="term-tab-pane" :class="{active: activeTab === 'terminal'}">
            <div id="xterm"></div>
          </div>

          <!-- Explorer Tab -->
          <div class="term-tab-pane" :class="{active: activeTab === 'explorer'}">
            <div class="term-window" style="margin-bottom: 16px;">
              <div class="term-titlebar">
                <div class="term-titlebar-btn close"></div>
                <div class="term-titlebar-btn minimize"></div>
                <div class="term-titlebar-btn maximize"></div>
                <div class="term-titlebar-title">upload@cloudcontrol:~</div>
              </div>
              <div class="term-window-content" style="padding: 16px;">
                <form action="/upload" method="post" enctype="multipart/form-data" class="term-dropzone" ref="upload">
                  <input name="path" :value="path" type="hidden"/>
                  <input name="power" :value="power" type="hidden"/>
                  <svg class="term-dropzone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                  <div class="term-dropzone-text">// DROP FILES HERE OR CLICK</div>
                </form>

                <div style="margin-top: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--term-text-dim); font-size: 0.8rem; font-family: var(--term-font);">UPLOAD_PATH:</label>
                  <input type="text" class="term-text-input" style="width: 100%;" placeholder="/data/local/tmp/" v-model="path">
                </div>

                <div style="margin-top: 12px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--term-text-dim); font-size: 0.8rem; font-family: var(--term-font);">CHMOD:</label>
                  <input type="text" class="term-text-input" style="width: 100%;" placeholder="755" v-model="power">
                </div>

                <div style="margin-top: 16px;">
                  <button id="upload_file" class="term-btn term-btn-primary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="17 8 12 3 7 8"/>
                      <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    EXECUTE_UPLOAD
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Inspector Tab -->
          <div class="term-tab-pane" :class="{active: activeTab === 'inspector'}">
            <div style="margin-bottom: 12px;">
              <button class="term-btn term-btn-primary" :disabled="loading" @click="screenDumpUI">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M23 4v6h-6M1 20v-6h6"/>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                DUMP_UI_HIERARCHY
              </button>
            </div>

            <div class="term-inspector-layout">
              <div class="term-inspector-screen">
                <canvas id="fgCanvas_tree" :style="canvasStyleTree" style="position: absolute; z-index: 10;"></canvas>
                <canvas id="bgCanvas_tree" :style="canvasStyleTree" style="position: absolute; z-index: 9;"></canvas>
              </div>

              <div class="term-inspector-tree" id="jstree-hierarchy"></div>

              <div class="term-inspector-props">
                <table class="term-props-table">
                  <tr>
                    <th>CLASS</th>
                    <td>[[elem.className || elem.type || '--']]</td>
                  </tr>
                  <tr>
                    <th>TEXT</th>
                    <td>[[elem.text || '--']]</td>
                  </tr>
                  <tr>
                    <th>DESC</th>
                    <td>[[elem.description || '--']]</td>
                  </tr>
                  <tr>
                    <th>RES_ID</th>
                    <td>[[elem.resourceId || '--']]</td>
                  </tr>
                  <tr>
                    <th>CLICK</th>
                    <td>[[elem.clickable]]</td>
                  </tr>
                  <tr>
                    <th>ENABLE</th>
                    <td>[[elem.enabled]]</td>
                  </tr>
                  <tr>
                    <th>XPATH</th>
                    <td>[[elemXpath || '--']]</td>
                  </tr>
                  <tr>
                    <th>POS</th>
                    <td>[[cursorValue.x]], [[cursorValue.y]]</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/jstree.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm@2.9.2/dist/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm@2.9.2/dist/addons/fit/fit.min.js"></script>
  <script src='/static/dropzone/dropzone.min.js'></script>
  <script src="/static/js/notify.js"></script>
  <script src="/static/js/common.js"></script>

  <script>
    var deviceIp = "{{IP}}";
    var devicePort = "{{Port}}";
    var deviceUdid = "{{ Udid}}";
    var device = {{ device | safe}};
  </script>

  <script>
    // Terminal setup
    var term;
    var websocket_term = new WebSocket("ws://" + deviceIp + ":7912/term");
    websocket_term.binaryType = "arraybuffer";

    function ab2str(buf) {
      return String.fromCharCode.apply(null, new Uint8Array(buf));
    }

    websocket_term.onopen = function(evt) {
      term = new Terminal({
        screenKeys: true,
        useStyle: true,
        cursorBlink: true,
        theme: {
          background: '#0a0a0a',
          foreground: '#00ff41',
          cursor: '#00ff41'
       }
     });

      term.on('data', function(data) {
        websocket_term.send(new TextEncoder().encode("\x00" + data));
     });
      term.on('resize', function(evt) {
        websocket_term.send(new TextEncoder().encode("\x01" + JSON.stringify({
          cols: evt.cols,
          rows: evt.rows
       })));
     });

      term.open(document.getElementById('xterm'));
      term.fit();

      websocket_term.onmessage = function(evt) {
        if (evt.data instanceof ArrayBuffer) {
          term.write(ab2str(evt.data));
       }
     };
      websocket_term.onclose = function(evt) {
        term.write("\r\n[SESSION_TERMINATED]");
     };
    };
  </script>

  <script src="/static/js/nio-client.js"></script>
  <script src="/static/js/remote.js?v=4"></script>

  <script>
    // Extend Vue app for tabs
    if (window.app) {
      window.app.activeTab = 'home';
    }

    // Dropzone setup
    Dropzone.autoDiscover = false;
    var my_dropzone = new Dropzone(".term-dropzone", {
      url: "http://" + window.location.host + "/upload",
      paramName: "file",
      maxFilesize: 1000.0,
      maxFiles: 2,
      addRemoveLinks: true,
      autoProcessQueue: false,
      dictDefaultMessage: '',
      headers: {'Access-Control-Allow-Origin': deviceUdid}
    });

    $('#upload_file').on('click', function(e) {
      e.preventDefault();
      my_dropzone.processQueue();
    });
  </script>
</body>
</html>
